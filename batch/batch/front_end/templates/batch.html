{% extends "layout.html" %}
{% block title %}Batch {{ batch['id'] }}{% endblock %}
{% block head %}
  <script src="{{ base_path }}/common_static/focus_on_keyup.js"></script>
{% endblock %}
{% block content %}

<h1>Batch {{ batch['id'] }}</h1>

<h2>Properties</h2>
<ul>
  <li>User: {{ batch['user'] }}</li>
  <li>Billing Project: {{ batch['billing_project'] }}</li>
  <li>Time Created: {% if 'time_created' in batch and batch['time_created'] is not none %}{{ batch['time_created'] }}{% endif %}</li>
  <li>Time Completed: {% if 'time_completed' in batch and batch['time_completed'] is not none %}{{ batch['time_completed'] }}{% endif %}</li>
  <li>Total Jobs: {{ batch['n_jobs'] }}</li>
  <ul>
    <li>Pending Jobs: {{ batch['n_jobs'] - batch['n_completed'] }}</li>
    <li>Succeeded Jobs: {{ batch['n_succeeded'] }}</li>
    <li>Failed Jobs: {{ batch['n_failed'] }}</li>
    <li>Cancelled Jobs: {{ batch['n_cancelled'] }}</li>
  </ul>
  <li>Duration: {% if 'duration' in batch and batch['duration'] is not none %}{{ batch['duration'] }}{% endif %}</li>
  <li>Cost: {% if 'cost' in batch and batch['cost'] is not none %}{{ batch['cost'] }}{% endif %}</li>
</ul>

{% if not batch['complete'] and batch['state'] != 'Cancelled' %}
<form action="{{ base_path }}/batches/{{ batch['id'] }}/cancel" method="post">
  <input type="hidden" name="_csrf" value="{{ csrf_token }}"/>
  {% if q is not none %}
  <input type="hidden" name="q" value="{{ q }}"/>
  {% endif %}
  <button>Cancel</button>
</form>
{% endif %}

<h2>Attributes</h2>
{% if 'attributes' in batch %}
{% for name, value in batch['attributes'].items() %}
<p>{{ name }}: {{ value }}</p>
{% endfor %}
{% endif %}

<h2>Jobs</h2>
<div class="flex-col">
  <div class="flex-col-align-right">
    <form method="GET" action="{{ base_path }}/batches/{{ batch['id'] }}">
      <input style="vertical-align:text-bottom;" id="searchBar" name="q" size=30 type="text"
        {% if q %}
        value="{{ q }}"
        {% else %}
          placeholder="Search terms..."
        {% endif %}
       >
      <button type="submit">Search</button>
    </form>
    <input id="expand-search-syntax-checkbox" class="expand-checkbox" type="checkbox">
    <label for="expand-search-syntax-checkbox" class="expand-label">Search Help</label>
    <div class="expand-content" style="max-width:75%;">
      <p>Search jobs with the given search terms.  Return jobs
        that match all terms.  Terms:</p>
      <ul>
        <li>job_id=JOB_ID - jobs with an id equal to JOB_ID</li>
        <li>k=v - jobs with an attribute with key k and value v</li>
        <li>has:k - jobs that have an attribute with key k</li>
        <li>state - jobs in the given state, one of:
          <ul>
            <li>ready</li>
            <li>running</li>
            <li>live (ready or running)</li>
            <li>cancelled</li>
            <li>error</li>
            <li>failed</li>
            <li>bad (error or failed)</li>
            <li>success</li>
            <li>done (cancelled, error, failed or success)</li>
          </ul>
        </li>
        <li>!term - jobs not matched by term</li>
      </ul>
    </div>
  </div>
  <div class='flex-col' style="overflow: auto;">
    <table class="data-table" id="batch" style="width: 100%">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>State</th>
          <th>Exit Code</th>
          <th>Duration</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody id="batch-table-body"></tbody>
    </table>
  </div>
  <button id="next-page" onclick="nextPage()">Load more...</button>
</div>

<script type="text/javascript">

  const pageData = [
    // FIXME unmock
    {% for i in range_mock %}
    {% for job in batch['jobs'] %}
      [
        [
          "{{ base_path }}/batches/{{ job['batch_id'] }}/jobs/{{ job['job_id'] }}",
          "{{ i + job['job_id'] }}",
        ],
        "{{ job['name'] }}",
        "{{ job['state'] }}",
        "{{ job['exit_code'] }}",
        "{{ job['duration'] }}",
        "{{ job['cost'] }}",
      ],
    {% endfor %}
    {% endfor %}
  ]

  const pageSize = 50
  let currentJobIdx = 0
  const nextPage = () => {
    const nextJobIdx = pageSize + currentJobIdx
    pageData
      .slice(currentJobIdx, nextJobIdx)
      .forEach(([[link, id], ...rest]) => {
        linkEle = document.createElement("a")
        linkEle.className = "fill-td"
        linkEle.href = link
        linkEle.innerHTML = id
        idEle = document.createElement("td")
        idEle.className = "numeric-cell" 
        idEle.appendChild(linkEle)
        row = document.createElement("tr");
        [
          idEle,
          ...rest.map((field) => {
            const ele = document.createElement("td")
            ele.innerHTML = field
            return ele
          })
        ].forEach((ele) => row.appendChild(ele))
        document.getElementById("batch-table-body").appendChild(row)
      })
    currentJobIdx = nextJobIdx
    if (currentJobIdx >= pageData.length) {
      document.getElementById("next-page").style.display = "none"
    }
  }

  nextPage()


  // TODO this ends up trying to hit https://auth.hail.is/login?https://:authority:path, which gets a cors error
  //      - fix cors settings on auth server
  //      - shouldn't it instead be hitting https://auth.hail.is/api/v1alpha/userinfo via impersonate_user_and_get_info? why is the redirect happening?
  fetch(
    "../api/v1alpha/batches/{{ batch['id'] }}/jobs",
    // { headers: { Authorization: "Bearer {{ session_id }}" } }
  ).then((result) => console.log(result))
</script>

<script type="text/javascript">
  focusOnSlash("searchBar");
</script>
{% endblock %}
